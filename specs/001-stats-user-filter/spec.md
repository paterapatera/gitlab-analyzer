# Feature Specification: 集計表示におけるユーザーフィルタリング

**Feature Branch**: `001-stats-user-filter`  
**Created**: 2026-02-04  
**Status**: Draft  
**Input**: User description: "集計表示画面にて、グラフとテーブルに表示するユーザーは、チェックボックスで選択できる。これにより欲しいユーザー情報だけで分析することができる。"

## Clarifications

### Session 2026-02-04

- Q: プロジェクト別ビューでの選択状態の保存スコープはどれにしますか？ → A: プロジェクト/ブランチ/年の組み合わせごとに選択状態を保存
- Q: チェックボックス一覧のユーザー表示順序はどれにしますか？ → A: ユーザー名（authorName）のアルファベット順（昇順）
- Q: チェックボックスのチェック/アンチェック時に、グラフとテーブルの更新タイミングはどれにしますか？ → A: リアルタイムで即座に更新（チェック直後に自動更新）
- Q: 横断ビューでのユーザーフィルタリングの振る舞いはどれにしますか？ → A: 横断ビューは独立した選択状態を持つ（プロジェクト別ビューの選択状態は反映されない）
- Q: 大量のユーザー（50名以上）が存在する場合のUI配置はどれにしますか？ → A: チェックボックス一覧をスクロール可能なコンテナに配置（高さ制限あり）

## User Scenarios & Testing _(mandatory)_

### User Story 1 - ユーザーフィルタリングによる集計表示 (Priority: P1)

ユーザー（分析者）は、月次コミット行数の集計表示画面（プロジェクト別ビュー・横断ビュー）において、チェックボックスでユーザーを選択/解除することで、グラフとテーブルに表示する対象ユーザーを絞り込むことができる。

**Why this priority**: 特定のユーザーやチームメンバーに焦点を当てた分析を可能にする、機能の中核となる価値を提供するため。

**Independent Test**: 複数ユーザーのコミットデータが保存済みの状態で、チェックボックスを操作→グラフとテーブルの表示内容が選択されたユーザーのみに絞られることを確認できる。

**Acceptance Scenarios**:

1. **Given** 複数ユーザーのコミットデータが保存済み、**When** ユーザーがプロジェクト/ブランチ/年を選択して集計画面を表示する、**Then** デフォルトで全ユーザーがチェックされた状態でユーザー選択チェックボックス一覧が表示される。
2. **Given** 集計画面にユーザー選択チェックボックスが表示されている、**When** ユーザーが特定のユーザーのチェックを外す、**Then** グラフとテーブルからそのユーザーのデータが除外される。
3. **Given** 集計画面にユーザー選択チェックボックスが表示されている、**When** ユーザーが特定のユーザーのチェックを入れる、**Then** グラフとテーブルにそのユーザーのデータが追加表示される。
4. **Given** 一部のユーザーのみが選択されている、**When** ユーザーがプロジェクトやブランチ、年を変更する、**Then** 新しい条件下でも同じユーザーの選択状態が保持される（存在する場合）。

---

### User Story 2 - 全選択/全解除の一括操作 (Priority: P2)

ユーザー（分析者）は、全ユーザーを一括で選択または解除できる操作を実行して、効率的にフィルタリング条件を変更できる。

**Why this priority**: 多数のユーザーが存在する場合に、個別チェックボックス操作の手間を削減し、ユーザビリティを向上させるため。

**Independent Test**: 10名以上のユーザーデータが保存済みの状態で、「全選択」「全解除」ボタンをクリック→全チェックボックスが一括で操作されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 複数ユーザーのチェックボックスが表示されている、**When** ユーザーが「全選択」操作を実行する、**Then** 全てのユーザーのチェックボックスが選択状態になる。
2. **Given** 複数ユーザーのチェックボックスが表示されている、**When** ユーザーが「全解除」操作を実行する、**Then** 全てのユーザーのチェックボックスが非選択状態になる。
3. **Given** 一部のユーザーのみが選択されている、**When** ユーザーが「全選択」操作を実行する、**Then** 全てのユーザーが選択状態になる。

---

### User Story 3 - 選択状態の永続化 (Priority: P3)

ユーザー（分析者）は、ユーザーフィルタリングの選択状態をアプリケーション内に保存し、同一のプロジェクト/ブランチ/年に戻った場合に同じ選択状態を維持できる。

**Why this priority**: 毎回同じユーザーを選択し直す手間を省き、分析作業の効率を向上させるため。

**Independent Test**: 特定のユーザーを選択して他の条件に切り替え→元の条件に戻る→同じ選択状態が復元されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーがプロジェクトA/main/2025で特定のユーザーを選択している、**When** 他のプロジェクトやブランチに切り替えてから再度プロジェクトA/main/2025に戻る、**Then** 前回の選択状態が復元される。
2. **Given** ユーザーがプロジェクトA/main/2025で選択状態を変更している、**When** プロジェクトA/develop/2025に切り替える、**Then** develop ブランチには独立した選択状態が適用される。
3. **Given** アプリケーションが再起動される、**When** ユーザーが前回と同じプロジェクト/ブランチ/年を選択する、**Then** 前回の選択状態が復元される（プロジェクト/ブランチ/年の組み合わせの粒度で保存）。

---

### Edge Cases

- 選択されているユーザーが0件の場合（グラフとテーブルは空になり、「ユーザーを選択してください」などのメッセージを表示する）。
- フィルタ条件変更後、選択されていたユーザーが新しい条件下に存在しない場合（該当ユーザーのチェックボックスは表示されず、選択状態は保持されるが表示には影響しない）。
- 大量のユーザー（50名以上）が存在する場合（チェックボックス一覧をスクロール可能なコンテナに配置し、100名以上でも滑らかなスクロール性能を保証する）。
- 同一ユーザー名が複数存在する場合（既存の集計キー（authorEmail優先、フォールバックauthorName）に基づいて一意に識別される）。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムは、月次コミット行数の集計表示画面（プロジェクト別ビュー、横断ビュー）において、ユーザー選択用のチェックボックス一覧を表示しなければならない。
- **FR-002**: チェックボックス一覧は、現在の集計条件（プロジェクト/ブランチ/年）に基づいて表示されるユーザーを含めなければならない。
- **FR-003**: ユーザーがチェックボックスを選択/解除した際、グラフとテーブルの表示内容は即座に自動更新され（明示的な「適用」ボタン不要）、選択されたユーザーのデータのみを表示しなければならない。
- **FR-004**: システムは、初期表示時に全ユーザーを選択状態（チェックON）でチェックボックス一覧を表示しなければならない。
- **FR-005**: システムは、「全選択」と「全解除」の一括操作機能を提供しなければならない。
- **FR-006**: システムは、ユーザーフィルタリングの選択状態を永続ストレージに保存しなければならない。
- **FR-007**: 保存された選択状態は、アプリケーション再起動後も復元されなければならない。
- **FR-008**: プロジェクト別ビューと横断ビューは、それぞれ独立したユーザー選択状態を保持しなければならない。横断ビューのユーザー選択状態は、プロジェクト別ビューの選択状態の影響を受けない。
- **FR-009**: システムは、選択されたユーザーが0件の場合、グラフとテーブルを空の状態で表示し、分かりやすいメッセージを提供しなければならない。
- **FR-010**: チェックボックス一覧は、ユーザー名（authorName）を表示し、集計キー（authorEmail優先、フォールバックauthorName）に基づいて一意に識別しなければならない。
- **FR-011**: チェックボックス一覧は、ユーザー名のアルファベット順（昇順）で表示されなければならない。
- **FR-012**: ユーザーが50名以上存在する場合、チェックボックス一覧はスクロール可能なコンテナ（高さ制限400px）に配置されなければならない。

### Key Entities _(include if feature involves data)_

- **ユーザー選択状態**: プロジェクト別ビューまたは横断ビューにおいて、どのユーザーが選択されているかを表す情報。ビュー種別ごとに独立して管理される。
- **ユーザー識別子**: 既存の集計キー（authorEmail優先、authorNameにフォールバック）に基づいて、各ユーザーを一意に識別する。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: ユーザーは、チェックボックス操作後1秒以内にグラフとテーブルの更新を確認できる。
- **SC-002**: ユーザーは、アプリケーション再起動後も前回の選択状態が復元されていることを確認できる。
- **SC-003**: 100名以上のユーザーが存在する場合でも、チェックボックス一覧のスクロール操作が滑らかに動作する。
- **SC-004**: ユーザーは、全選択/全解除操作により、個別チェックボックス操作の手間を50%以上削減できる。
