# Feature Specification: GitLab 月次コミット行数分析

**Feature Branch**: `001-gitlab-commit-lines`  
**Created**: 2026-02-03  
**Status**: Draft  
**Input**: User description: "GitLabで誰が1ヶ月に何行コミットしたのかを確認し、各ユーザーの生産性を分析できるようにする。"

## Clarifications

### Session 2026-02-03

- Q: 月次コミット行数の「グラフ」は、どの表現にしますか？ → A: 集合縦棒グラフでx軸=月(1〜12)、系列=ユーザー（複数）。y軸=追加+削除
- Q: 「ユーザーの同一人物判定（集計キー）」は何を採用しますか？ → A: authorEmail を集計キー（画面・ログには出さない）。無い場合は authorName にフォールバック
- Q: 「追加行/削除行が取得できないコミット」の扱いはどれにしますか？ → B: 0扱いで集計（欠損は0として足す）＋UIに「欠損件数」を表示
- Q: 横断ビューの「対象範囲（ブランチ）」はどれにしますか？ → A: 保存済みの全ブランチを合算（収集されたものが対象）
- Q: 「月次集計の基準タイムゾーン」はどれにしますか？ → A: UTC（committedDate をUTCとして月判定）

## User Scenarios & Testing _(mandatory)_

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.

  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - GitLab 接続設定とプロジェクト同期 (Priority: P1)

ユーザー（Author）は、GitLab のベースURLとアクセストークンを登録し、アクセス可能なプロジェクト一覧を同期できる。

**Why this priority**: 後続のコミット収集・集計閲覧の前提となるため。

**Independent Test**: テスト用GitLab（またはテストプロジェクト）に対して、URL/トークン登録→プロジェクト一覧が表示/更新されることを確認できる。

**Acceptance Scenarios**:

1. **Given** GitLabのベースURLとトークンが未登録、**When** ユーザーがベースURLとトークンを登録する、**Then** 登録が保存され、次回起動でも利用できる。
2. **Given** 有効なベースURLとトークンが登録済み、**When** ユーザーがプロジェクト一覧を同期する、**Then** アクセス可能なプロジェクト一覧が更新される。
3. **Given** 無効なトークンが登録されている、**When** ユーザーが同期を実行する、**Then** 同期は失敗し、ユーザーが次に取るべき行動（再入力/権限確認）が分かるエラーメッセージが表示される。

---

### User Story 2 - コミット収集と保存 (Priority: P2)

ユーザー（Author）は、プロジェクト名、ブランチ名、収集期間（開始/終了）を指定し、GitLab からコミットを取得してアプリケーション内の永続ストレージに保存できる。
開始日未指定の場合は最古の取得可能日から、終了日未指定の場合は現在時刻までを対象とする。

**Why this priority**: 収集済みデータがないと集計ができないため。

**Independent Test**: 任意のプロジェクト/ブランチで期間を指定して収集→保存件数が増えること、同条件で再収集しても重複が増えないことを確認できる。

**Acceptance Scenarios**:

1. **Given** プロジェクト一覧が同期済み、**When** ユーザーがプロジェクトとブランチを選択し、期間を未指定のまま収集を実行する、**Then** 取得可能な範囲（最古〜現在）でコミットが収集・保存される。
2. **Given** 期間（開始日/終了日）が指定されている、**When** ユーザーが収集を実行する、**Then** 指定期間内のコミットが収集・保存される。
3. **Given** 既に保存済みのコミットが存在する、**When** 同一プロジェクト/ブランチ/同一SHAのコミットが再度取得される、**Then** 重複は作成されず、保存データは一意に保たれる。
4. **Given** ネットワーク障害やGitLab側エラーが発生する、**When** 収集を実行する、**Then** 途中まで保存されたデータは保持され、失敗理由と再実行の可否がユーザーに提示される。

---

### User Story 3 - 月次コミット行数の集計を閲覧 (Priority: P3)

ユーザー（Author）は、保存済みコミットデータから、各ユーザーの「追加行 + 削除行」の月次合計をグラフと表で閲覧できる。
グラフは集合縦棒グラフとし、x軸=月(1〜12)、系列=ユーザー（複数）、y軸=（追加行 + 削除行）の合計を表示する。
閲覧は2つの切り口を提供する。

1. プロジェクト別: プロジェクト名（セレクトボックス）、ブランチ名（セレクトボックス）、西暦（セレクトボックス）、ユーザー（チェックボックス）
2. 横断: 西暦（セレクトボックス）、ユーザー（チェックボックス）。保存済みの全プロジェクト・全ブランチのデータを合算して表示する（収集されたものが対象）。

**Why this priority**: 本機能の価値（生産性分析）が直接得られるため。

**Independent Test**: 小さな保存済みデータセットで、フィルタ変更→グラフ/表の数値が期待通りに変わることを確認できる。

**Acceptance Scenarios**:

1. **Given** ある年のコミットデータが保存済み、**When** ユーザーがプロジェクト/ブランチ/年/ユーザーを選択する、**Then** グラフと表に該当ユーザーの月次合計が表示される。
2. **Given** 複数プロジェクトのデータが保存済み、**When** ユーザーが年/ユーザーのみを指定する（横断ビュー）、**Then** 全プロジェクト横断の月次合計が表示される。
3. **Given** 表示対象にメールアドレスが含まれるデータが保存されている、**When** ユーザーが閲覧する、**Then** 画面上にメールアドレスは表示されない。
4. **Given** トークンが保存されている、**When** 画面表示やログ出力が行われる、**Then** トークンは画面にもログにも表示されない。

---

[Add more user stories as needed, each with an assigned priority]

### Edge Cases

- 収集開始日が収集終了日より後の場合（入力エラーとして扱う）。
- 対象ブランチが削除/リネームされている場合（分かりやすいメッセージと再選択を促す）。
- 同一ユーザー名が複数存在する/表示名が変更される場合（集計キーは authorEmail を優先し、authorEmail が無い場合は authorName にフォールバックする。同一人物判定の限界を明示し、利用者が選択で調整できる）。
- 追加行/削除行が取得できないコミットが存在する場合（欠損は0扱いで集計し、UIに欠損件数を表示して扱いを明示する）。
- 大量データ収集時に時間がかかる場合（進捗・キャンセル・再開の体験を損ねない）。
- 月境界（タイムゾーン差異）で集計月がずれる可能性（集計はUTC基準で一貫させ、表示上の注記で明示する）。

## Requirements _(mandatory)_

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right functional requirements.
-->

### Functional Requirements

- **FR-001**: システムは GitLab のベースURLを登録・更新できなければならない。
- **FR-002**: システムは GitLab のアクセストークンを登録・更新できなければならない。
- **FR-003**: ユーザーは、登録済みの接続情報を用いてプロジェクト一覧を同期できなければならない。
- **FR-004**: システムは、同期済みプロジェクトの中からプロジェクト名を選択できるUIを提供しなければならない。
- **FR-005**: システムは、選択したプロジェクトに対してブランチ名を選択できるUIを提供しなければならない。
- **FR-006**: ユーザーは、収集開始日・収集終了日を任意に指定できなければならない。
- **FR-007**: 収集開始日が未指定の場合、システムは取得可能な最古の範囲から収集しなければならない。
- **FR-008**: 収集終了日が未指定の場合、システムは現在時刻までを収集対象にしなければならない。
- **FR-009**: システムは、指定条件（プロジェクト/ブランチ/期間）に基づき GitLab からコミットを取得し、永続ストレージに保存しなければならない。
- **FR-010**: 保存されるコミットは、少なくとも以下の属性を保持しなければならない：sha、メッセージ、コミット日時、作者名、作者メール、追加行数、削除行数。
- **FR-011**: システムは、同一プロジェクト/同一ブランチ/同一shaのコミットを重複して保存してはならない。
- **FR-012**: ユーザーは、プロジェクト別ビューで「プロジェクト名・ブランチ名・西暦・ユーザー（複数選択）」を指定して集計を閲覧できなければならない。
- **FR-013**: ユーザーは、横断ビューで「西暦・ユーザー（複数選択）」を指定して集計を閲覧できなければならない。
- **FR-014**: グラフは集合縦棒グラフで、x軸=1〜12月、系列=ユーザー（複数）、y軸=（追加行 + 削除行）の合計を表示しなければならない。
- **FR-015**: 表は x軸=1〜12月、y軸=ユーザー名とし、各セルに（追加行 + 削除行）の合計を表示しなければならない。
- **FR-016**: システムは、画面上にアクセストークンを表示してはならない。
- **FR-017**: システムは、画面上に作者メールアドレスを表示してはならない。
- **FR-018**: システムは、ログにアクセストークンを出力してはならない。
- **FR-019**: システムは、ログに作者メールアドレスを出力してはならない。
- **FR-020**: システムは、トークンおよびメールアドレスを暗号化して保存することを必須要件としてはならない（やらないこと）。
- **FR-021**: システムは、ユーザー別集計のキーとして authorEmail を優先的に用いなければならない。authorEmail が取得できない場合は authorName を用いなければならない。
- **FR-022**: システムは、追加行/削除行が取得できないコミットの件数（欠損件数）を集計結果と併せてUIに表示しなければならない。
- **FR-023**: システムは、横断ビューの集計において、保存済みの全プロジェクト・全ブランチのデータを合算して表示しなければならない（収集されたものが対象）。
- **FR-024**: システムは、月次集計の月判定において committedDate をUTC基準で扱わなければならない。

### Assumptions

- 本アプリケーションは個人利用を主目的とし、収集したデータはユーザー端末内に保存される。
- 集計の「行数」は、コミットの追加行数と削除行数の合計とする。
- 集計の「1ヶ月」は、committedDate をUTC基準として暦月（1〜12月）で集計する。

### Out of Scope

- アクセストークンおよび作者メールアドレスの暗号化（やらないこと）。
- コミット行数以外の高度な開発生産性指標（レビュー時間、課題消化数など）の算出。
- 組織横断の権限管理や共有（複数ユーザーで同一データを共有すること）。

### Key Entities _(include if feature involves data)_

- **GitLab接続設定**: ベースURL、アクセストークン（表示・ログ出力は不可）。
- **プロジェクト**: ユーザーがアクセスできるGitLabプロジェクト。選択肢として利用される。
- **ブランチ**: プロジェクト内の分析対象ブランチ。選択肢として利用される。
- **コミット**: プロジェクト/ブランチに紐づくコミット。
  - 識別: projectId + branchName + sha
  - 属性: message, committedDate, authorName, authorEmail, additions, deletions
- **集計結果**: 年・月・ユーザー単位の（追加行 + 削除行）合計値。
  - ユーザー識別: authorEmail を優先（非表示・非ログ）。authorEmail が無い場合は authorName。

## Success Criteria _(mandatory)_

<!--
  ACTION REQUIRED: Define measurable success criteria.
  These must be technology-agnostic and measurable.
-->

### Measurable Outcomes

- **SC-001**: 新規ユーザーが、URL/トークン登録からプロジェクト一覧同期までを 3 分以内に完了できる。
- **SC-002**: 保存済みデータに対する集計表示は、フィルタ変更から 2 秒以内にグラフ/表が更新される。
- **SC-003**: 表示される各ユーザーの合計値は、保存済みコミットデータにおける（追加行 + 削除行）の合計と一致する（同一条件で再集計しても結果が変わらない）。
- **SC-004**: UI とログを確認しても、アクセストークンおよび作者メールアドレスが露出しない（0件である）。
