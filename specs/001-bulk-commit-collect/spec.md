# Feature Specification: Bulk Commit Continuation

**Feature Branch**: `001-bulk-commit-collect`  
**Created**: 2026-02-06  
**Status**: Draft  
**Input**: User description: "ユーザーとして、ワンボタンで、すべての収集済みのコミットの続きを一括で収集したい。なぜなら、一つずつ続きのコミットを収集するのは時間がかかるため。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - ワンボタンで全対象の続きを収集 (Priority: P1)

収集済みの対象すべてについて、ワンボタンで続きを一括収集できる。

**Why this priority**: 逐次操作の時間コストを最小化し、主要な価値を直接提供するため。

**Independent Test**: 収集履歴がある対象が複数ある状態で一括収集を開始し、全対象の続きを収集できることを確認する。

**Acceptance Scenarios**:

1. **Given** 収集履歴がある対象が複数ある状態, **When** ユーザーが一括収集を開始する, **Then** 全ての対象について続きの収集が開始され完了する
2. **Given** 収集履歴がある対象が存在しない状態, **When** ユーザーが一括収集を開始する, **Then** 対象がない旨が通知され処理が開始されない

---

### User Story 2 - 進捗と結果の可視化 (Priority: P2)

一括収集の進捗と結果を確認できる。

**Why this priority**: 収集の状態を把握できない不安や再操作を減らし、運用の安心感を高めるため。

**Independent Test**: 一括収集の実行中に進捗が表示され、完了後に結果サマリが表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** 一括収集が実行中, **When** ユーザーが画面を確認する, **Then** 総対象数と進行状況が表示される
2. **Given** 一括収集が完了した状態, **When** ユーザーが結果を確認する, **Then** 対象ごとの成功/失敗と新規コミット件数が確認できる

---

### User Story 3 - 失敗対象の再試行 (Priority: P3)

失敗した対象だけを再試行できる。

**Why this priority**: 一部失敗時の再操作コストを下げ、成功済み対象の再実行を避けるため。

**Independent Test**: 失敗対象がある一括収集の後、再試行で失敗対象のみが再実行されることを確認する。

**Acceptance Scenarios**:

1. **Given** 一括収集の結果に失敗対象が含まれる, **When** ユーザーが失敗対象のみ再試行する, **Then** 成功済み対象は再実行されず失敗対象のみが再実行される

---

### Edge Cases

- 対象数が非常に多い場合でも操作が開始できるか
- 対象の一部で権限が失われている場合の扱い（失敗として記録され、再試行可能とする）
- 既に一括収集が実行中の場合の二重実行防止
- 途中でアプリが終了した場合の再開や結果の扱い（処理済みの結果は保存され、再開時に未処理分から継続可能）
- ユーザーによる中止操作時の扱い（処理済みの結果は保存され、次回は未処理分から再開可能）
- 通信制限や一時的な障害が発生した場合の扱い（失敗として記録され、再試行可能とする）
- GitLab APIエラー、ネットワーク障害、データ保存失敗など、あらゆるエラーを失敗とみなす

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムは、収集履歴がある全ての対象について、単一の操作で続きを一括収集できなければならない
- **FR-002**: システムは、一括収集の対象を「収集履歴がある対象」として判定しなければならない
- **FR-003**: システムは、各対象について前回の収集点以降のコミットを収集し、成功時に収集点を更新しなければならない
- **FR-004**: システムは、一括収集の進捗を総対象数、完了数、失敗数として表示しなければならない
- **FR-005**: システムは、完了後に対象ごとの成功/失敗と新規コミット件数を含む結果サマリを提示しなければならない
- **FR-006**: システムは、失敗した対象のみを再試行できる操作を提供しなければならない
- **FR-007**: システムは、実行中の一括収集を中止できる手段を提供しなければならない
- **FR-008**: システムは、一括収集の開始時刻、終了時刻、対象数、結果を記録しなければならない
- **FR-009**: システムは、対象を順次実行（1つずつ順番に処理）しなければならない
- **FR-010**: システムは、各対象の処理完了ごとに結果を保存し、中断時には処理済み結果を保持しなければならない
- **FR-011**: システムは、中断後の再開時に未処理の対象のみを処理対象とし、既に成功した対象は再実行しないこと

### Key Entities _(include if feature involves data)_

- **Collection Target**: 収集履歴を持つ対象。(プロジェクトID, ブランチ名) のペアで一意に識別される。
- **Collection Checkpoint**: 対象ごとの最終収集点。最後に収集したコミットの `committed_date_utc` の最大値を保存し、この時刻以降のコミットを次回収集する。
- **Bulk Collection Run**: 一括収集の実行単位
- **Collection Result**: 対象ごとの結果（成功/失敗、新規コミット件数）

## Clarifications

### Session 2026-02-06

- Q: 「収集履歴がある対象」とは具体的に何を指しますか？ → A: (プロジェクト、ブランチ) のペア（各ブランチが独自の収集チェックポイントを持つ）
- Q: 「Collection Checkpoint（収集点）」には具体的にどのようなデータを保存しますか？ → A: 最後に収集したコミットの `committed_date_utc` の最大値
- Q: 対象の収集が「失敗」とみなされるのは、どのような場合ですか？ → A: すべて（APIエラー、ネットワークエラー、データ保存エラーなど）
- Q: 一括収集で複数の対象を処理する際、並行実行しますか？それとも順次実行しますか？ → A: 順次実行（1つずつ順番に収集し、リソース消費を抑える）
- Q: 一括収集の途中でユーザーが中止した場合、または予期せずアプリが終了した場合、処理済みの結果はどう扱いますか？ → A: 処理済みの結果は保存され、再開時に継続可能

## Assumptions

- 一括収集の対象は、既に収集履歴がある対象に限定される
- 一括収集の開始はワンボタンの単一操作で行われる
- 失敗対象の再試行は、直近の一括収集結果を基に行われる

## Dependencies

- 収集履歴データが保存されていること
- 対象へのアクセス権限が有効であること

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 収集履歴がある対象が100件の場合、90%の一括収集が10分以内に完了する
- **SC-002**: ユーザーは10秒以内に一括収集を開始し、5秒以内に進捗表示を確認できる
- **SC-003**: 失敗対象のみ再試行した場合、成功済み対象の再実行が0件である
- **SC-004**: 一括収集後、ユーザーの「作業時間が短縮された」との回答が80%以上になる
