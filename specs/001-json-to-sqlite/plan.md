# Implementation Plan: SQLiteストレージへの移行

**Branch**: `001-json-to-sqlite` | **Date**: 2026-02-06 | **Spec**: [specs/001-json-to-sqlite/spec.md](specs/001-json-to-sqlite/spec.md)
**Input**: Feature specification from [specs/001-json-to-sqlite/spec.md](specs/001-json-to-sqlite/spec.md)

## Summary

- JSON ファイル保存を SQLite に置き換え、既存の Tauri コマンド群（接続設定/プロジェクト同期/コミット収集/統計）で同等機能を維持する。
- 大量コミット（10万〜100万件）でも集計/検索が 3〜5 秒以内に完了するよう、インデックスとトランザクションを設計する。
- スキーマバージョニングとマイグレーションの仕組みを導入し、将来の変更に耐えるストレージ基盤を整える。

## Technical Context

**Language/Version**: TypeScript ~5.6.2 / React 18.3 / Vite 6 / Rust (edition 2021) / Tauri 2  
**Primary Dependencies**: React, @tauri-apps/api, Tauri, serde, reqwest, tokio, chrono  
**Storage**: SQLite（端末ローカルのアプリデータディレクトリ）  
**Testing**: Vitest（frontend）、cargo test（backend）  
**Target Platform**: Desktop（Tauri: Windows/macOS/Linux）  
**Project Type**: Tauri デスクトップアプリ（React frontend + Rust backend）  
**Performance Goals**: 月次集計 3 秒以内（10万件）、検索/集計 5 秒以内（100万件）  
**Constraints**: 既存コマンド API 互換、トランザクションで整合性確保、accessToken/authorEmail の非露出と SQLite 保存  
**Scale/Scope**: 個人利用を想定、最大 100 万件のコミットを扱う

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

### Initial Check (Before Phase 0)

- ✅ **Code Quality**: SQLite 接続/マイグレーション/クエリ周辺の複雑ロジックに日本語コメントと `NOTE:` を付与する。
- ✅ **Testing**: リポジトリ/クエリ層の unit + コマンド境界の契約テストを追加する。
- ✅ **UX Consistency**: UI 変更は最小限、既存の状態表示パターンを踏襲する。
- ✅ **MCP Usage**: 可能なら serena で探索、UI 追加が出た場合は shadcn を利用する。
- ✅ **Reusability**: JSON/SQLite を切り替えやすいリポジトリ境界を維持する。
- ✅ **Security & Privacy**: accessToken は UI/ログ非表示を維持し、SQLite に保存する（ログ/画面には出さない）。

### Post-Design Check (After Phase 1)

- ✅ **Code Quality**: リポジトリ/マイグレーションを小さな関数に分割し、JSDoc/`///` コメントを必須化する設計。
- ✅ **Testing**: SQLite の CRUD/集計クエリ/マイグレーションのテスト計画を quickstart に明記。
- ✅ **UX Consistency**: 既存 UI を維持し、エラーメッセージの文言・状態表示を揃える。
- ✅ **MCP Usage**: 既存モジュール探索は serena を使う方針（利用不可なら代替と理由を記録）。
- ✅ **Reusability**: Repository 抽象を活かし、ストレージ差し替えポイントを明確化。
- ✅ **Security & Privacy**: 秘密情報の暗号化/マスキング方針と SQL インジェクション対策を research/quickstart に反映。

## Project Structure

### Documentation (this feature)

```text
specs/001-json-to-sqlite/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
└── tasks.md             # Phase 2 output (not generated by /speckit.plan)
```

### Source Code (repository root)

```text
src/                       # React UI
├── App.tsx
├── main.tsx
└── features/

src-tauri/                 # Rust (Tauri backend)
├── src/
│   ├── commands/
│   ├── storage/
│   │   ├── repository.rs
│   │   ├── schema.rs
│   │   └── (new) sqlite/
│   ├── domain/
│   └── paths.rs
└── tauri.conf.json
```

**Structure Decision**: Tauri デスクトップアプリ構成を維持し、SQLite 実装は `src-tauri/src/storage/` 配下に集約する。

## Complexity Tracking

> No violations. This section is intentionally left empty.
